---
- name: bootstrap an ubuntu microk8s vagrant box
  hosts: all, localhost
  become: true
  vars_files:
  - vars.yml

  tasks:
  - name: install microk8s snap
    command: snap install --classic --channel {{kube_version}}/stable microk8s
    # TODO: after 2.8 is released
    #snap:
    #  name: microk8s
    #  state: present
    #  channel: "{{kube_version}}/stable"
    #  classic: true

  - name: alias the microk8s kubectl
    command: snap alias microk8s.kubectl kubectl

  - name: start microk8s
    command: microk8s.start

  - name: wait until microk8s is truly up
    command: microk8s.status --wait-ready

  - name: enable microk8s extensions
    command: microk8s.enable {{item}}
    with_items:
    - "{{extensions}}"

  - name: label the dashboard as a cluster service so it appears under cluster-info
    command: kubectl -n kube-system label svc kubernetes-dashboard kubernetes.io/cluster-service=true

  # TODO: replace 10.0.2.15 with 192.168.8.8 somehow with https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html#regular-expression-filters
  - name: capture config information
    command: microk8s.config
    register: config_contents

  - name: display config information
    debug:
      var: config_contents.stdout
